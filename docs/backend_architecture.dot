digraph BananaWeatherBackend {
    rankdir=LR;
    node [shape=rect, style=filled, fillcolor=white, fontname="Lato"];
    edge [fontname="Lato"];

    subgraph cluster_cloud {
        label = "Google Cloud Platform";
        bgcolor = "#f5f5f5";
        
        CloudRun [label="Cloud Run Service\n(Go Server)", shape=box3d, fillcolor="#e1f5fe"];
        GCS [label="Cloud Storage\n(Bucket)", shape=cylinder, fillcolor="#e0e0e0"];
        Firestore [label="Firestore\n(Database)", shape=cylinder, fillcolor="#fff9c4"];
        VertexAI [label="Vertex AI\n(Models)", shape=hexagon, fillcolor="#fff3e0"];
        MapsAPI [label="Google Maps Platform", shape=component, fillcolor="#e8f5e9"];
    }

    subgraph cluster_server {
        label = "Go Backend Internal";
        bgcolor = "#e1f5fe";
        
        Main [label="main.go"];
        Router [label="Chi Router"];
        Handler [label="api/handler.go"];
        
        subgraph cluster_packages {
            label = "Packages";
            bgcolor = "#b3e5fc";
            PkgGenAI [label="pkg/genai"];
            PkgMaps [label="pkg/maps"];
            PkgStorage [label="pkg/storage"];
            PkgDB [label="pkg/database"];
        }
        
        Tools [label="cmd/generate_preset\n(CLI Tool)", shape=parallelogram, fillcolor="#d1c4e9"];
    }

    // Flow
    User [shape=circle, label="User"];
    Admin [shape=circle, label="Admin"];
    
    User -> CloudRun [label="HTTP Request"];
    Admin -> Tools [label="CLI"];
    
    CloudRun -> Main;
    Main -> Router;
    Router -> Handler [label="/api/weather\n/api/presets"];

    // Handler Dependencies
    Handler -> PkgMaps [label="Resolve Location"];
    Handler -> PkgDB [label="Check Cache (TTL)\nFetch Presets"];
    Handler -> PkgGenAI [label="Generate Content\n(If Cache Miss)"];
    Handler -> PkgStorage [label="Persist Assets"];

    // External Calls
    PkgMaps -> MapsAPI [label="Geocoding"];
    
    PkgGenAI -> VertexAI [label="Gemini 3 Pro (Img)\nVeo 3.1 (Vid)"];
    
    PkgStorage -> GCS [label="Upload Image/Video"];
    PkgDB -> Firestore [label="Upsert/Get Locations"];
    
    // Data Flow
    VertexAI -> PkgGenAI [label="Content"];
    PkgGenAI -> Handler [label="Results"];
    Handler -> PkgDB [label="Upsert Cache"];
    Handler -> User [label="SSE Stream\n(Status, URL)"];
    
    // Tooling Flow
    Tools -> PkgGenAI;
    Tools -> PkgStorage;
    Tools -> PkgDB;
    Tools -> GCS [label="Batch Upload"];
    Tools -> Firestore [label="Batch Upsert"];
}
